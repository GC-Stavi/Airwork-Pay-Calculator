<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Airwork Pay Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Layout & Base Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: linear-gradient(to bottom right, #f0f4f8, #e0e7ee);
            color: #334155;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Top Banner --- */
        .top-banner {
            width: 100%;
            background-color: #1e293b; /* Dark blue-gray */
            padding: 0.8em 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.25);
            z-index: 100;
            color: #ffffff;
            position: relative; /* Added for positioning context */
        }

        .top-banner h1 {
            font-size: 1.8em;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin: 0;
            font-weight: 700;
        }

        /* --- Page Header --- */
        header {
            width: 100%;
            max-width: 1000px;
            text-align: center;
            margin: 2rem auto 0;
            padding: 0 20px;
        }

        header p {
            font-size: 1.1em;
            color: #64748b;
            margin-bottom: 20px;
        }

        header hr {
            max-width: 250px;
            margin: 20px auto 30px auto;
            border: 0;
            border-top: 2px solid #cbd5e1;
        }

        /* --- Main Content Container --- */
        .container {
            max-width: 1000px;
            width: 95%;
            margin: 1rem auto;
            background: #ffffff;
            padding: 2em;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        
        /* --- Form & Input Styles --- */
        .roster-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .roster-inputs.casual-mode .input-group:first-child {
            grid-column: 1 / -1;
        }


        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #475569;
        }

        .input-group select, .input-group input {
            width: 100%;
            padding: 0.8em;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1em;
            background-color: #f8fafc;
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            padding: 1em;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            resize: vertical;
            font-size: 14px;
        }

        .options-grid {
            margin-bottom: 1.5rem;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .checkbox-group {
            margin-bottom: 1rem; /* Spacing for stacked checkboxes */
        }


        .checkbox-group input {
            margin-right: 0.5em;
        }
        
        .calculate-section {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* --- Help Section --- */
        .help-section {
            margin-top: 1.5rem;
        }
        .help-section details {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .help-section summary {
            font-weight: 600;
            padding: 0.8em 1em;
            cursor: pointer;
            outline: none;
        }
        .help-section div {
            padding: 0 1em 1em 1em;
            border-top: 1px solid #e2e8f0;
        }
        .help-section ol {
            padding-left: 20px;
            margin: 0;
        }
        .help-section li {
            margin-bottom: 0.5em;
        }


        /* --- Buttons & Controls --- */
        .top-controls {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            z-index: 110;
        }
        
        button {
            padding: 0.8em 1.6em;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        
        button.primary-button {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: #ffffff;
            font-size: 1.1em;
            padding: 0.9em 2em;
        }
        
        button.primary-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .dark-toggle-btn {
            background: #e2e8f0;
            color: #475569;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
            max-width: 800px;
            width: 90%;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.8em;
            font-weight: bold;
            color: #94a3b8;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-content h3, .modal-content h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        .modal-content hr {
            border: 0;
            border-top: 1px solid #e2e8f0;
            margin: 1.5rem 0;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1.5rem;
            align-items: center;
        }
        
        .results-grid p {
            margin: 0.5rem 0;
        }
        
        .results-grid .label {
            font-weight: 600;
        }
        
        .total-pay-section {
            text-align: center;
            margin-top: 1.5rem;
        }
        
        .total-pay-section p {
            font-size: 1.6em;
            font-weight: bold;
            color: #16a34a;
        }
        
        .changes-list {
            list-style-type: none;
            padding-left: 0;
        }
        .changes-list li {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #f59e0b; /* Amber color for changes */
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
        }

        .hidden {
            display: none;
        }
        
        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            color: #e2e8f0;
        }

        body.dark-mode .container, body.dark-mode .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
        }
        
        body.dark-mode .top-banner {
             background-color: #0f172a;
        }

        body.dark-mode header p {
            color: #94a3b8;
        }

        body.dark-mode header hr, body.dark-mode .modal-content hr {
            border-top-color: #475569;
        }

        body.dark-mode .dark-toggle-btn {
            background: #334155;
            color: #e2e8f0;
        }
        
        body.dark-mode .input-group label {
            color: #cbd5e1;
        }

        body.dark-mode .input-group select,
        body.dark-mode .input-group input,
        body.dark-mode textarea {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        body.dark-mode .modal-content h3, body.dark-mode .modal-content h4 {
             color: #f1f5f9;
        }
        
        body.dark-mode .modal-close-button {
             color: #94a3b8;
        }
        
        body.dark-mode .changes-list li, body.dark-mode .help-section details {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        
        body.dark-mode .help-section details {
            border-color: #4a5568;
        }

        body.dark-mode .help-section div {
             border-top-color: #4a5568;
        }


    </style>
</head>
<body>

    <div class="top-banner">
        <h1>Airwork Pay Calculator</h1>
        <div class="top-controls">
            <button class="dark-toggle-btn" onclick="toggleDarkMode()" id="darkModeBtn">Dark Mode</button>
        </div>
    </div>

    <header>
        <p>A tool to estimate pilot pay based on the Airwork 2017 Enterprise Agreement.</p>
        <hr>
    </header>

    <main class="container">
        
        <div class="input-group">
            <label for="employmentType">Employment Type</label>
            <select id="employmentType" onchange="toggleMode()">
                <option value="Permanent">Permanent</option>
                <option value="Casual">Casual</option>
            </select>
        </div>

        <div id="permanentInputs">
            <div class="input-grid">
                <div class="input-group">
                    <label for="rankSelect">Rank</label>
                    <select id="rankSelect">
                        <option value="First Officer">First Officer</option>
                        <option value="Captain">Captain</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="levelSelect">Pay Level</label>
                    <select id="levelSelect">
                        <option value="1">Level 1 (1-3 Yrs)</option>
                        <option value="2">Level 2 (4 Yrs)</option>
                        <option value="3">Level 3 (5 Yrs)</option>
                        <option value="4">Level 4 (6 Yrs)</option>
                        <option value="5">Level 5 (7 Yrs)</option>
                        <option value="6">Level 6 (8+ Yrs)</option>
                    </select>
                </div>
            </div>
            <div class="options-grid">
                <div class="checkbox-group">
                    <label><input type="checkbox" id="isRHS"> Right Hand Seat Pilot</label>
                </div>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="isTrainingCaptain"> Training/Check Captain</label>
                </div>
            </div>
        </div>
        
        <div id="casualInputs" class="hidden">
             <div class="input-group">
                <label for="casualRankSelect">Rank</label>
                <select id="casualRankSelect">
                    <option value="First Officer">First Officer</option>
                    <option value="Captain">Captain</option>
                </select>
            </div>
        </div>


        <div class="roster-inputs" id="rosterInputsContainer">
            <div class="input-group" id="initialRosterGroup">
                <label for="initialRosterInput">Initial Roster</label>
                <textarea id="initialRosterInput" placeholder="Paste the initial roster text here..."></textarea>
            </div>
            <div class="input-group" id="finalRosterGroup">
                <label for="finalRosterInput" id="finalRosterLabel">Final Roster</label>
                <textarea id="finalRosterInput" placeholder="Paste the final published roster text here..."></textarea>
            </div>
        </div>
        
        <div class="help-section">
            <details>
                <summary>Help with Copy & Paste from PDF</summary>
                <div>
                    <p>If Ctrl+A doesn't select text across multiple pages in your PDF viewer, follow these steps:</p>
                    <ol>
                        <li>Find the original PDF file on your computer.</li>
                        <li><strong>Right-click</strong> on the file icon.</li>
                        <li>Go to <strong>"Open with"</strong> and select <strong>Google Chrome</strong> or <strong>Microsoft Edge</strong>.</li>
                        <li>Once the PDF opens in your browser, press <strong>Ctrl+A</strong> (or Cmd+A on Mac) to select all text.</li>
                        <li>Press <strong>Ctrl+C</strong> (or Cmd+C) to copy, then paste into the correct box above.</li>
                    </ol>
                </div>
            </details>
        </div>
        
        <div class="calculate-section">
            <button class="primary-button" onclick="runCalculation(1)">Calculate 1st Fortnight</button>
            <button class="primary-button" onclick="runCalculation(2)">Calculate 2nd Fortnight</button>
        </div>
        
    </main>

    <div id="resultsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="hideResultsModal()">&times;</button>
            <div id="modal-results-content">
                </div>
        </div>
    </div>
    
    <script>
        // --- GLOBAL VARIABLES ---
        let calculationResults = {};

        // --- DATA CONSTANTS (EBA Rates) ---
        const EBA_DATA = {
            "Permanent": {
                "First Officer": { 1: 134700.41, 2: 140812.55, 3: 147931.28, 4: 153524.47, 5: 160049.07, 6: 167370.08 },
                "Captain": { 1: 213689.97, 2: 219975.39, 3: 227532.08, 4: 236339.95, 5: 246400.17, 6: 255208.04 }
            },
            "Casual": {
                "First Officer": { "Standard": 191.85, "GroundDuty": 470.00 },
                "Captain": { "Standard": 295.16, "GroundDuty": 620.00, "Training": 312.16, "Checking": 328.57 }
            },
            "AppB1aRate": { "First Officer": 178.07, "Captain": 277.78 },
            "AppB1bcRate": { "First Officer": 68.17, "Captain": 108.00 }, // Captain rate is estimated
            "ExtendedDutyRate": { "First Officer": 178.07, "Captain": 277.78 },
            "MealAllowance": { "Breakfast": 34.90, "Lunch": 39.12, "Dinner": 67.26 },
            "LayoverComponent": 25.30,
            "RHSAllowance": 1412.50, // Per quarter
            "TrainingCaptainAllowance": 9800.00, // Per annum
            "SuperGuaranteeRate": 0.115 // As of July 2024
        };

        // --- UI FUNCTIONS ---
        function showResultsModal() { document.getElementById('resultsModal').style.display = 'flex'; }
        function hideResultsModal() { document.getElementById('resultsModal').style.display = 'none'; }
        function toggleDarkMode() {
            const body = document.body;
            const btn = document.getElementById('darkModeBtn');
            const isDark = body.classList.toggle('dark-mode');
            btn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            localStorage.setItem('darkMode', isDark ? 'dark' : 'light');
        }
        function toggleMode() {
            const mode = document.getElementById('employmentType').value;
            const isCasual = mode === 'Casual';
            document.getElementById('permanentInputs').classList.toggle('hidden', isCasual);
            document.getElementById('casualInputs').classList.toggle('hidden', !isCasual);
            document.getElementById('initialRosterGroup').classList.toggle('hidden', isCasual);
            document.getElementById('rosterInputsContainer').classList.toggle('casual-mode', isCasual);
            document.getElementById('finalRosterLabel').textContent = isCasual ? 'Roster' : 'Final Roster';
        }

        // --- ON PAGE LOAD ---
        window.onload = function() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedMode === 'dark' || (!savedMode && prefersDark)) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeBtn').textContent = 'Light Mode';
            }

            // Populate text areas with sample data from the conversation
            document.getElementById('initialRosterInput').value = `TimeMode Local time
Roster
(01MAY25-31MAY25)
Kendell, Guy 0463AU BNE FO/73F
17APR25 00:36 0463AU
Date Des. Code CI Dep STD Arr STA CO AC WA Func Rank BLH
01 Thu ADMIN BNE 0900 BNE 1700 1700 FO
02 Fri DIL BNE 0000 BNE 2359 FO
03 Sat RDO BNE 0000 BNE 2359 FO
04 Sun RDO BNE 0000 BNE 2359 FO
05 Моп FETC BNE 0700 BNE 0930 0930 FO
06 Tue ADMIN BNE 0900 BNE 1700 1700 FO
07 Wed PAX BNE 0800 MEL 0900 1130 1200 FO
HTL MEL 1200 MEL 0250+ FO
08 Thu F QF7282 MEL 0250 PER 0350 0605 0635 73P 04:15 FO
HTL PER 0635 PER 1710 FO
F QF7281 PER 1710 MEL 1810 2340 0010+ 73P 03:30 FO
09 Fri HTL MEL 0010 MEL 1115 FO
PAX MEL 1115 BNE 1215 1430 1500 FO
10 Sat RDO BNE 0000 BNE 2359 FO
11 Sun RDO ΒΝΕ 0000 BNE 2359 FO
12 Моп PAX BNE 0800 MEL 0900 1125 1155 FO
HTL MEL 1155 MEL 0250+ FO
13 Tue RCA QF7282 F MEL 0250 PER 0350 0605 0635 73P FO 04:15
HTL PER 0640 PER 1710 FO
RCA QF7281 F PER 1710 MEL 1810 2340 0010+ 73P FO 03:30
14 Wed HTL MEL 0010 MEL 1325 FO
PAX MEL 1325 BNE 1425 1640 1710 FO
15 Thu ADMIN BNE 0900 BNE 1700 1700 FO
16 Fri ADMIN BNE 0900 BNE 1700 1700 FO
17 Sat RDO BNE 0000 BNE 2359 FO
18 Sun RDO BNE 0000 BNE 2359 FO
19 Моп ADMIN BNE 0900 BNE 1700 1700. FO
20 Tue PAX BNE 0800 MEL 0900 1125 1155 FO
HTL MEL 1155 MEL 2340 FO
QF7286 F MEL 2340 LST 0040 0140 73P FO 01:00
21 Wed F QF7287 LST 0210 MEL 0310 0340 73P FO 01:00
HTL MEL 0340 MEL 0800+ FO
22 Thu PREF MEL 0800 MEL 1600 FO
PAX ACKD MEL 1830 BNE 2045 2115 FO
23 Fri ADMIN BNE 0900 BNE 1700 1700 FO
24 Sat RDO BNE 0000 BNE 2359 FO
25 Sun RDO BNE 0000 BNE 2359 FO`;

            document.getElementById('finalRosterInput').value = `TimeMode Local time
Roster
(01MAY25-31MAY25)
Kendell, Guy 0463AU BNE FO/73F
25JUN25 00:53 0463AU
Date Des. Code E Dep STD Arr CI STA CO AC WA Rank BLH Func
01 Thu ADMIN BNE 0900 BNE 1700 1700 FO
02 Fri DIL BNE 0000 BNE 2359 FO
03 Sat RDO BNE 0000 BNE 2359 FO
04 Sun RDO BNE 0000 BNE 2359 FO
05 Моп FETC BNE 0700 BNE 0930 0930 FO
06. Tue ADMIN BNE 0900 BNE 1700 1700 FO
07 Wed PAX BNE 0905 MEL 1005 1230 1300 FO
HTL MEL 1200 MEL 0250+ FO
08 Thu F QF7282 MEL 0250 PER 0350 0605 0621 73P 03:54 FO
HTL PER 0635 PER 1710 FO
Y,X F QF7281 PER 1710 MEL 1810 2340 0012+ 73P FO 03:57
09 Fri HTL MEL 0010 MEL 1115 FO
PAX MEL 1115 BNE 1215 1430 1500 FO
10 Sat RDO BNE 0000 BNE 2359 FO
11 Sun RDO 0000 BNE ΒΝΕ 2359 FO
12 Моп PAX BNE 0800 MEL 0900 1125 1155 FO
HTL MEL 1155 MEL 0250+ FO
13 Tue RCA QF7282 F MEL 0250 PER 0350 0605 0635 73P FO 04:13
HTL PER 0640 PER 1710 FO
RCA QF7281 F PER 1710 MEL 1810 2340 2344 73P FO 03:33
14 Wed HTL MEL 0010 MEL 2340 FO
Y.X QF7286 F MEL 2340 LST 0040 0140 73P FO 01:12
15 Thu F QF7287 LST 0210 MEL 0310 0335 73P 00:53 FO
HTL MEL 0310 MEL 0600 FO
PIOT MEL 0600 BNE 0815 FO
17 Sat PAX BNE 0905 SIN 1105 1725 1825 FO
HTL SIN 1825 SIN 0550+ FO
18 Sun XSP CAR 0550 SIN 0650 FO
XSP AWK990 T 0700 XSP 0800 0930 73P 01:43 FO
Y,X AWK992 F XSP 1045 PER 1610 1846 73P 06:02 FO
HTL PER 1846 PER 1000+ FO
20 Tue AWK992 F PER 1000 MEL 1100 1630 1801 73P 03:46 FO
HTL MEL 1718 MEL 0800+ FO
22 Thu PREF MEL 0800 MEL 1600 FO
PAX ACKD MEL 1830 BNE 2045 2115 FO
24 Sat RDO BNE 0000 BNE 2359 FO
25 Sun RDO BNE 0000 BNE 2359 FO`;
            
            document.getElementById('resultsModal').addEventListener('click', function(event) {
                if (event.target === this) { hideResultsModal(); }
            });
        };

        // --- CALCULATION & PARSING LOGIC ---
        function parseTimeToHours(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return 0;
            const cleanedTime = timeStr.replace(/[:+]/g, '');
            if (cleanedTime.length < 3) return 0; // Needs at least HMM or HHMM
            const hours = parseInt(cleanedTime.slice(0, -2), 10);
            const minutes = parseInt(cleanedTime.slice(-2), 10);
            if (isNaN(hours) || isNaN(minutes)) return 0;
            return hours + (minutes / 60);
        }
        
        const MONTHS_MAP = { 'JAN': 0, 'FEB': 1, 'MAR': 2, 'APR': 3, 'MAY': 4, 'JUN': 5, 'JUL': 6, 'AUG': 7, 'SEP': 8, 'OCT': 9, 'NOV': 10, 'DEC': 11 };

        function getPublicationDate(rosterText) {
            const match = rosterText.match(/(\d{2})([A-Z]{3})(\d{2})\s+(\d{2}:\d{2})/);
            if (!match) return null;
            const day = parseInt(match[1], 10);
            const month = MONTHS_MAP[match[2]];
            const year = 2000 + parseInt(match[3], 10);
            const timeParts = match[4].split(':');
            const hours = parseInt(timeParts[0], 10);
            const minutes = parseInt(timeParts[1], 10);
            if (isNaN(day) || month === undefined || isNaN(year) || isNaN(hours) || isNaN(minutes)) return null;
            return new Date(year, month, day, hours, minutes);
        }

        function parseRoster(rosterText) {
            const dutyMap = new Map();
            const lines = rosterText.trim().split('\n');
            let rosterPeriod = null;
            const dateRangeRegex = /\((\d{2})([A-Z]{3})(\d{2})\s*-\s*(\d{2})([A-Z]{3})(\d{2})\)/;
            const rangeMatch = rosterText.match(dateRangeRegex);
            if (rangeMatch) {
                rosterPeriod = {
                    startDay: rangeMatch[1], startMonth: rangeMatch[2], startYear: rangeMatch[3],
                    endDay: rangeMatch[4], endMonth: rangeMatch[5], endYear: rangeMatch[6]
                };
            }
            let currentDayEntries = [];
            for (const line of lines) {
                if (/^\d{2}\s+(Sun|Mon|Tue|Wed|Thu|Fri|Sat)/.test(line.trim())) {
                    if (currentDayEntries.length > 0) {
                        const date = currentDayEntries[0].trim().split(/\s+/)[0];
                        dutyMap.set(date, processDayEntries(currentDayEntries));
                    }
                    currentDayEntries = [line];
                } else if (currentDayEntries.length > 0) { // ensure we've started a day
                    currentDayEntries.push(line); 
                }
            }
            if (currentDayEntries.length > 0) {
                const date = currentDayEntries[0].trim().split(/\s+/)[0];
                dutyMap.set(date, processDayEntries(currentDayEntries));
            }
            return { dutyMap, rosterPeriod };
        }
        
        function processDayEntries(entries) {
            const firstLineParts = entries[0].trim().split(/\s+/);
            const dayInfo = { 
                date: firstLineParts[0], 
                dayName: firstLineParts[1], 
                dutyCode: firstLineParts[2] || 'UNKNOWN',
                isRDO: false,
                std: null, 
                signOff: null, 
                blockHours: 0, 
                isLayover: false, 
                isGroundDuty: false, 
                isLeave: false, 
                isFlight: false,
                isTravel: false
            };
            let dutyStart = null, dutyEnd = null;

            const groundDutyCodes = ['ADMIN', 'SIM', 'FETC', 'PREF'];
            const leaveCodes = ['AL', 'DIL'];
            const flightCodes = ['QF', 'AWK', 'XSP'];
            
            entries.forEach(line => {
                const parts = line.trim().split(/\s+/);
                const dutyCode = parts[2];

                if (line.includes('RDO')) dayInfo.isRDO = true;
                if (groundDutyCodes.includes(dutyCode)) dayInfo.isGroundDuty = true;
                if (leaveCodes.includes(dutyCode)) dayInfo.isLeave = true;
                if (flightCodes.some(code => line.includes(code))) dayInfo.isFlight = true;
                if (line.includes('PAX') || line.includes('PIOT')) dayInfo.isTravel = true;
                if (line.includes('HTL')) dayInfo.isLayover = true;
                
                const blockHoursMatch = line.match(/(\d{1,2}:\d{2})$/);
                if (blockHoursMatch) {
                    dayInfo.blockHours += parseTimeToHours(blockHoursMatch[0]);
                }
                
                // Find duty start and end times for the entire day's entry
                const timeMatches = line.match(/\b\d{4}\b/g) || [];
                if (timeMatches.length > 0) {
                    if (dutyStart === null || timeMatches[0] < dutyStart) {
                        dutyStart = timeMatches[0];
                    }
                    const potentialEnd = line.match(/\b\d{4}\+?/g);
                    if (potentialEnd && potentialEnd.length > 0) {
                        const lastTime = potentialEnd[potentialEnd.length - 1];
                         if (dutyEnd === null || lastTime.replace('+','') > dutyEnd) {
                            dutyEnd = lastTime.replace('+','');
                        }
                    }
                }
            });

            dayInfo.std = dutyStart;
            dayInfo.signOff = dutyEnd;

            return dayInfo;
        }
        
        function getPayPeriodDates(rosterPeriod, periodNumber) {
            const year = 2000 + parseInt(rosterPeriod.startYear, 10);
            const startMonthIndex = MONTHS_MAP[rosterPeriod.startMonth];
            if (periodNumber === 1) { // Approx 28th of prev month to 11th of current month
                const startDate = new Date(Date.UTC(year, startMonthIndex - 1, 28));
                const endDate = new Date(Date.UTC(year, startMonthIndex, 11));
                return { startDate, endDate };
            } else { // Approx 12th to 25th of current month
                const startDate = new Date(Date.UTC(year, startMonthIndex, 12));
                const endDate = new Date(Date.UTC(year, startMonthIndex, 25));
                return { startDate, endDate };
            }
        }
        
        function filterDutiesByPayPeriod(dutyMap, startDate, endDate, rosterPeriod) {
            const filteredMap = new Map();
            const startYear = startDate.getUTCFullYear();
            const startMonth = startDate.getUTCMonth();
            const endMonth = endDate.getUTCMonth();
            
            dutyMap.forEach((duty, dateKey) => {
                const dutyDay = parseInt(duty.date, 10);
                let dutyMonth = MONTHS_MAP[rosterPeriod.startMonth];
                
                // Logic to handle dates crossing month boundaries for the pay period
                if (startMonth !== endMonth) {
                     if (dutyDay >= startDate.getUTCDate()) {
                        dutyMonth = startMonth;
                     } else {
                        dutyMonth = endMonth;
                     }
                }
                const dutyDate = new Date(Date.UTC(startYear, dutyMonth, dutyDay));

                if(dutyDate >= startDate && dutyDate <= endDate) {
                    filteredMap.set(dateKey, duty);
                }
            });
            return filteredMap;
        }

        function compareRosters(initialRoster, finalRoster) {
            const changes = [];
            const buffer = 2.0; 
            
            finalRoster.forEach((finalDuty, date) => {
                const initialDuty = initialRoster.get(date);
                
                if (!initialDuty || initialDuty.isRDO) {
                    if (finalDuty.isRDO) return; // RDO to RDO, no change
                    
                    changes.push({ 
                        date, 
                        type: "RDO_WORKED", 
                        description: `RDO changed to ${finalDuty.dutyCode}.`, 
                        blockHours: finalDuty.blockHours, 
                        isFlight: finalDuty.isFlight,
                        isTravelOrGround: finalDuty.isTravel || finalDuty.isGroundDuty
                    });
                    return;
                }

                if (!initialDuty.isRDO && !finalDuty.isRDO && initialDuty.std !== finalDuty.std) {
                     const initialTime = parseTimeToHours(initialDuty.std);
                     const finalTime = parseTimeToHours(finalDuty.std);
                     const timeDiff = Math.abs(initialTime - finalTime);

                     if (timeDiff > buffer) {
                         changes.push({ 
                             date, 
                             type: "OUTSIDE_BUFFER", 
                             description: `Duty start changed by ${timeDiff.toFixed(2)} hrs.`, 
                             blockHours: finalDuty.blockHours 
                         });
                     }
                }
            });
            return changes;
        }

        function calculatePermanentPay(finalRosterData, level, rank, detectedChanges) {
            const annualSalary = EBA_DATA.Permanent[rank]?.[level];
            if (!annualSalary) return { totalGrossPay: 0 };

            let appB1aPay = 0, appB1bcPay = 0, extendedDutyPay = 0;
            
            detectedChanges.forEach(change => {
                if (change.type === 'RDO_WORKED') {
                    if (change.isFlight) { // App B1a for flying
                        appB1aPay += Math.max(3, change.blockHours) * EBA_DATA.AppB1aRate[rank];
                    } else if(change.isTravelOrGround) { // App B1b & c for non-flying
                        // Represents "one day's pay"
                        const dailyRate = annualSalary / 365.25;
                        appB1bcPay += dailyRate; 
                    }
                } else if (change.type === 'OUTSIDE_BUFFER') {
                    extendedDutyPay += change.blockHours * EBA_DATA.ExtendedDutyRate[rank];
                }
            });

            const { mealPay, layoverPay, leaveDays } = calculateAllowances(finalRosterData);
            let otherAllowances = 0;
            if (document.getElementById('isRHS').checked) {
                // RHS allowance is quarterly. This is a fortnightly estimate.
                otherAllowances += EBA_DATA.RHSAllowance / (3 * 2.167); 
            }
            if (document.getElementById('isTrainingCaptain').checked) {
                otherAllowances += (EBA_DATA.TrainingCaptainAllowance / 365.25) * 14;
            }

            const dailyRate = annualSalary / 365.25;
            const leavePay = leaveDays * dailyRate;
            const fortnightlyBasePay = (annualSalary / 365.25) * 14; 
            
            const totalAllowances = appB1aPay + appB1bcPay + extendedDutyPay + mealPay + layoverPay + otherAllowances;
            const superablePay = fortnightlyBasePay + appB1bcPay + otherAllowances; // Super on ordinary time earnings
            const superContribution = superablePay * EBA_DATA.SuperGuaranteeRate;
            const totalGrossPay = fortnightlyBasePay + totalAllowances;
            
            return { fortnightlyBasePay, leavePay, appB1aPay, appB1bcPay, extendedDutyPay, mealPay, layoverPay, otherAllowances, superContribution, totalGrossPay };
        }

        function calculateCasualPay(finalRosterData, rank) {
            const casualRates = EBA_DATA.Casual[rank];
            let flightPay = 0, groundPay = 0, totalBlockHours = 0, groundDutyDays = 0;

            finalRosterData.dutyMap.forEach(duty => {
                if(duty.isGroundDuty) {
                    groundDutyDays++;
                    groundPay += casualRates.GroundDuty;
                } else if(duty.blockHours > 0) {
                     totalBlockHours += duty.blockHours;
                }
            });

            flightPay = totalBlockHours * casualRates.Standard;
            const totalGrossPay = flightPay + groundPay;
            const superContribution = totalGrossPay * EBA_DATA.SuperGuaranteeRate;
            return { totalBlockHours, groundDutyDays, totalGrossPay, groundPay, flightPay, superContribution };
        }

        function calculateAllowances(finalRosterData) {
            let mealPay = 0, layoverPay = 0, leaveDays = 0;
            finalRosterData.dutyMap.forEach(duty => {
                if (duty.isLeave) {
                    leaveDays++; 
                    return;
                }
                if (duty.isLayover) {
                    layoverPay += EBA_DATA.LayoverComponent;
                    // Assuming a full set of meals for each layover day for simplicity
                    mealPay += EBA_DATA.MealAllowance.Breakfast + EBA_DATA.MealAllowance.Lunch + EBA_DATA.MealAllowance.Dinner;
                }
            });
            return { mealPay, layoverPay, leaveDays };
        }

        function updateModalContent() {
            const res = calculationResults;
            const contentDiv = document.getElementById('modal-results-content');
            const formatCurrency = (num) => num.toLocaleString('en-AU', { style: 'currency', currency: 'AUD' });

            if (res.mode === 'Permanent') {
                 let changesHtml = '<h4>Detected Roster Changes</h4>';
                if (res.detectedChanges.length > 0) {
                    changesHtml += '<ul class="changes-list">';
                    res.detectedChanges.forEach(change => {
                        const month = res.rosterPeriod.startMonth || 'Month';
                        changesHtml += `<li><strong>${change.date} ${month}:</strong> ${change.description}</li>`;
                    });
                    changesHtml += '</ul>';
                } else {
                    changesHtml += '<p>No pay-relevant changes detected between the initial and final rosters for this pay period.</p>';
                }

                contentDiv.innerHTML = `
                    <h3>Pay Calculation Results (Permanent)</h3>
                    <div class="results-grid">
                        <p class="label">Rank:</p><p>${res.finalRank}</p>
                        <p class="label">Pay Period:</p><p>${res.payPeriod.start} to ${res.payPeriod.end}</p>
                    </div><hr>${changesHtml}<hr>
                    <h4>Pay Component Breakdown (Fortnightly Estimate)</h4>
                    <div class="results-grid">
                        <p class="label">Base Pay (14 days):</p><p>${formatCurrency(res.fortnightlyBasePay)}</p>
                        <p class="label">App B1a - RDO Flying:</p><p>${formatCurrency(res.appB1aPay)}</p>
                        <p class="label">App B1b/c - RDO Ground/Travel:</p><p>${formatCurrency(res.appB1bcPay)}</p>
                        <p class="label">Extended Duty:</p><p>${formatCurrency(res.extendedDutyPay)}</p>
                        <p class="label">Meal Allowances:</p><p>${formatCurrency(res.mealPay)}</p>
                        <p class="label">Layover Allowances:</p><p>${formatCurrency(res.layoverPay)}</p>
                        <p class="label">Other Allowances (RHS/Training):</p><p>${formatCurrency(res.otherAllowances)}</p>
                    </div>
                    <div class="total-pay-section">
                        <h4>Estimated Total Fortnightly Gross Pay:</h4>
                        <p>${formatCurrency(res.totalGrossPay)}</p>
                    </div>
                    <hr>
                    <div class="results-grid">
                         <p class="label">Estimated Superannuation:</p><p>${formatCurrency(res.superContribution)}</p>
                    </div>`;

            } else if (res.mode === 'Casual') {
                 contentDiv.innerHTML = `
                    <h3>Pay Calculation Results (Casual)</h3>
                     <div class="results-grid">
                        <p class="label">Rank:</p><p>${res.finalRank}</p>
                        <p class="label">Pay Period:</p><p>${res.payPeriod.start} to ${res.payPeriod.end}</p>
                    </div><hr>
                    <h4>Pay Component Breakdown (Fortnightly)</h4>
                    <div class="results-grid">
                        <p class="label">Flight Pay (${res.totalBlockHours.toFixed(2)} hrs):</p><p>${formatCurrency(res.flightPay)}</p>
                        <p class="label">Ground Duty Pay (${res.groundDutyDays} days):</p><p>${formatCurrency(res.groundPay)}</p>
                    </div>
                    <div class="total-pay-section">
                        <h4>Estimated Total Fortnightly Gross Pay:</h4>
                        <p>${formatCurrency(res.totalGrossPay)}</p>
                    </div>
                    <hr>
                    <div class="results-grid">
                         <p class="label">Superannuation Contribution:</p><p>${formatCurrency(res.superContribution)}</p>
                    </div>`;
            } else {
                 contentDiv.innerHTML = '<h3>Error</h3><p>Could not calculate pay. Please check inputs and ensure valid rosters are provided.</p>';
            }
        }

        function runCalculation(periodNumber) {
            const employmentType = document.getElementById('employmentType').value;
            
            if(employmentType === 'Permanent') {
                let initialRosterText = document.getElementById('initialRosterInput').value;
                let finalRosterText = document.getElementById('finalRosterInput').value;

                if (!initialRosterText || !finalRosterText) {
                    alert("Please provide both initial and final rosters for permanent pay calculation.");
                    return;
                }

                const initialPubDate = getPublicationDate(initialRosterText);
                const finalPubDate = getPublicationDate(finalRosterText);
                
                // Auto-swap if final roster was published before initial
                if (initialPubDate && finalPubDate && initialPubDate > finalPubDate) {
                    [initialRosterText, finalRosterText] = [finalRosterText, initialRosterText];
                    document.getElementById('initialRosterInput').value = initialRosterText;
                    document.getElementById('finalRosterInput').value = finalRosterText;
                    alert("Rosters appeared to be in the wrong order and have been swapped based on publication date.");
                }

                const rank = document.getElementById('rankSelect').value;
                const level = document.getElementById('levelSelect').value;
                const initialRosterData = parseRoster(initialRosterText);
                const finalRosterData = parseRoster(finalRosterText);

                if (!finalRosterData.rosterPeriod || !initialRosterData.rosterPeriod) {
                    alert("Could not detect a valid roster period, e.g., (01MAY25-31MAY25), from the pasted text."); return;
                }
                
                const { startDate, endDate } = getPayPeriodDates(finalRosterData.rosterPeriod, periodNumber);
                
                const filteredInitialDuties = filterDutiesByPayPeriod(initialRosterData.dutyMap, startDate, endDate, initialRosterData.rosterPeriod);
                const filteredFinalDuties = filterDutiesByPayPeriod(finalRosterData.dutyMap, startDate, endDate, finalRosterData.rosterPeriod);

                const detectedChanges = compareRosters(filteredInitialDuties, filteredFinalDuties);
                const permanentPay = calculatePermanentPay({dutyMap: filteredFinalDuties}, level, rank, detectedChanges);

                calculationResults = {
                    mode: 'Permanent',
                    finalRank: rank,
                    annualSalary: EBA_DATA.Permanent[rank]?.[level],
                    ...permanentPay,
                    detectedChanges,
                    payPeriod: {start: startDate.toLocaleDateString('en-AU', {timeZone: 'UTC'}), end: endDate.toLocaleDateString('en-AU', {timeZone: 'UTC'})},
                    rosterPeriod: finalRosterData.rosterPeriod
                };

            } else { // Casual
                const finalRosterText = document.getElementById('finalRosterInput').value;
                 if (!finalRosterText) {
                    alert("Please provide the roster for casual pay calculation.");
                    return;
                }
                const finalRosterData = parseRoster(finalRosterText);
                 if (!finalRosterData.rosterPeriod) {
                    alert("Could not detect a valid roster period, e.g., (01MAY25-31MAY25), from the pasted text."); return;
                }
                const { startDate, endDate } = getPayPeriodDates(finalRosterData.rosterPeriod, periodNumber);
                const filteredFinalDuties = filterDutiesByPayPeriod(finalRosterData.dutyMap, startDate, endDate, finalRosterData.rosterPeriod);
                const rank = document.getElementById('casualRankSelect').value;
                const casualPay = calculateCasualPay({dutyMap: filteredFinalDuties}, rank);

                calculationResults = {
                    mode: 'Casual',
                    finalRank: rank,
                    ...casualPay,
                    payPeriod: {start: startDate.toLocaleDateString('en-AU', {timeZone: 'UTC'}), end: endDate.toLocaleDateString('en-AU', {timeZone: 'UTC'})},
                    rosterPeriod: finalRosterData.rosterPeriod
                };
            }
            
            updateModalContent();
            showResultsModal();
        }

    </script>
</body>
</html>
