<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Airwork Pay Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- General Layout & Base Styles --- */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: linear-gradient(to bottom right, #f0f4f8, #e0e7ee);
            color: #334155;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- Top Banner --- */
        .top-banner {
            width: 100%;
            background-color: #1e293b; /* Dark blue-gray */
            padding: 0.8em 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.25);
            z-index: 100;
            color: #ffffff;
            position: relative; /* Added for positioning context */
        }

        .top-banner h1 {
            font-size: 1.8em;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            margin: 0;
            font-weight: 700;
        }

        /* --- Page Header --- */
        header {
            width: 100%;
            max-width: 1000px;
            text-align: center;
            margin: 2rem auto 0;
            padding: 0 20px;
        }

        header p {
            font-size: 1.1em;
            color: #64748b;
            margin-bottom: 20px;
        }

        header hr {
            max-width: 250px;
            margin: 20px auto 30px auto;
            border: 0;
            border-top: 2px solid #cbd5e1;
        }

        /* --- Main Content Container --- */
        .container {
            max-width: 1000px;
            width: 95%;
            margin: 1rem auto;
            background: #ffffff;
            padding: 2em;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        
        /* --- Form & Input Styles --- */
        .roster-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .roster-inputs.casual-mode .input-group:first-child {
            grid-column: 1 / -1;
        }


        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .options-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
             gap: 1rem;
             margin-bottom: 1.5rem;
        }


        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #475569;
        }

        .input-group select, .input-group input {
            width: 100%;
            padding: 0.8em;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1em;
            background-color: #f8fafc;
            box-sizing: border-box;
        }

        textarea {
            width: 100%;
            height: 200px;
            font-family: monospace;
            padding: 1em;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            resize: vertical;
            font-size: 14px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .checkbox-group {
            margin-bottom: 1rem; /* Spacing for stacked checkboxes */
        }


        .checkbox-group input {
            margin-right: 0.5em;
        }
        
        .calculate-section {
            display: flex;
            justify-content: center;
            margin-top: 1.5rem;
        }

        /* --- Help Section --- */
        .help-section {
            margin-top: 1.5rem;
        }
        .help-section details {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .help-section summary {
            font-weight: 600;
            padding: 0.8em 1em;
            cursor: pointer;
            outline: none;
        }
        .help-section div {
            padding: 0 1em 1em 1em;
            border-top: 1px solid #e2e8f0;
        }
        .help-section ol {
            padding-left: 20px;
            margin: 0;
        }
        .help-section li {
            margin-bottom: 0.5em;
        }


        /* --- Buttons & Controls --- */
        .top-controls {
            position: absolute;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            z-index: 110;
        }
        
        button {
            padding: 0.8em 1.6em;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        
        button.primary-button {
            background: linear-gradient(to right, #4f46e5, #7c3aed);
            color: #ffffff;
            font-size: 1.1em;
            padding: 0.9em 2em;
        }
        
        button.primary-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .dark-toggle-btn {
            background: #e2e8f0;
            color: #475569;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 2em;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
            max-width: 800px;
            width: 90%;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 1.8em;
            font-weight: bold;
            color: #94a3b8;
            cursor: pointer;
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-content h3, .modal-content h4 {
            margin-top: 0;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        .modal-content hr {
            border: 0;
            border-top: 1px solid #e2e8f0;
            margin: 1.5rem 0;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.5rem 1.5rem;
            align-items: center;
        }
        
        .results-grid p {
            margin: 0.5rem 0;
        }
        
        .results-grid .label {
            font-weight: 600;
        }
        
        .total-pay-section {
            text-align: center;
            margin-top: 1.5rem;
        }
        
        .total-pay-section p {
            font-size: 1.6em;
            font-weight: bold;
            color: #16a34a;
        }
        
        .changes-list {
            list-style-type: none;
            padding-left: 0;
        }
        .changes-list li {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #f59e0b; /* Amber color for changes */
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
        }

        .hidden {
            display: none;
        }
        
        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background: linear-gradient(to bottom right, #1e293b, #0f172a);
            color: #e2e8f0;
        }

        body.dark-mode .container, body.dark-mode .modal-content {
            background: #1e293b;
            border: 1px solid #334155;
        }
        
        body.dark-mode .top-banner {
             background-color: #0f172a;
        }

        body.dark-mode header p {
            color: #94a3b8;
        }

        body.dark-mode header hr, body.dark-mode .modal-content hr {
            border-top-color: #475569;
        }

        body.dark-mode .dark-toggle-btn {
            background: #334155;
            color: #e2e8f0;
        }
        
        body.dark-mode .input-group label {
            color: #cbd5e1;
        }

        body.dark-mode .input-group select,
        body.dark-mode .input-group input,
        body.dark-mode textarea {
            background-color: #2d3748;
            border-color: #4a5568;
            color: #e2e8f0;
        }
        
        body.dark-mode .modal-content h3, body.dark-mode .modal-content h4 {
             color: #f1f5f9;
        }
        
        body.dark-mode .modal-close-button {
             color: #94a3b8;
        }
        
        body.dark-mode .changes-list li, body.dark-mode .help-section details {
            background-color: #2d3748;
            border-color: #4a5568;
        }
        
        body.dark-mode .help-section details {
            border-color: #4a5568;
        }

        body.dark-mode .help-section div {
             border-top-color: #4a5568;
        }
    </style>
</head>
<body>

    <div class="top-banner">
        <h1>Airwork Pay Calculator</h1>
        <div class="top-controls">
            <button class="dark-toggle-btn" onclick="toggleDarkMode()" id="darkModeBtn">Dark Mode</button>
        </div>
    </div>

    <header>
        <p>A tool to estimate pilot pay based on the Airwork 2017 Enterprise Agreement.</p>
        <hr>
    </header>

    <main class="container">
        
        <div class="input-grid">
             <div class="input-group">
                <label for="employmentType">Employment Type</label>
                <select id="employmentType" onchange="toggleMode()">
                    <option value="Permanent">Permanent</option>
                    <option value="Casual">Casual</option>
                </select>
            </div>
             <div class="input-group">
                <label for="payPeriod">Pay Period</label>
                <select id="payPeriod">
                    <option value="14">Fortnightly</option>
                    <option value="28">Monthly</option>
                </select>
            </div>
        </div>

        <div id="permanentInputs">
            <div class="input-grid">
                <div class="input-group">
                    <label for="rankSelect">Rank</label>
                    <select id="rankSelect">
                        <option value="First Officer">First Officer</option>
                        <option value="Captain">Captain</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="levelSelect">Pay Level</label>
                    <select id="levelSelect">
                        <option value="1">Level 1 (1-3 Yrs)</option>
                        <option value="2">Level 2 (4 Yrs)</option>
                        <option value="3">Level 3 (5 Yrs)</option>
                        <option value="4">Level 4 (6 Yrs)</option>
                        <option value="5">Level 5 (7 Yrs)</option>
                        <option value="6">Level 6 (8+ Yrs)</option>
                    </select>
                </div>
            </div>
            <div class="options-grid">
                <div class="checkbox-group">
                    <label><input type="checkbox" id="isRHS"> Right Hand Seat Pilot</label>
                </div>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="isTrainingCaptain"> Training Captain</label>
                </div>
                <div class="checkbox-group">
                    <label><input type="checkbox" id="isFlightExaminer"> Flight Examiner Captain</label>
                </div>
                <div class="input-group">
                    <label for="assessmentDays">Days Undergoing Assessment/Training</label>
                    <input type="number" id="assessmentDays" value="0" min="0">
                </div>
            </div>
        </div>
        
        <div id="casualInputs" class="hidden">
             <div class="input-group">
                <label for="casualRankSelect">Rank</label>
                <select id="casualRankSelect">
                    <option value="First Officer">First Officer</option>
                    <option value="Captain">Captain</option>
                </select>
            </div>
        </div>

        <div class="roster-inputs" id="rosterInputsContainer">
            <div class="input-group" id="initialRosterGroup">
                <label for="initialRosterInput">Initial Roster</label>
                <textarea id="initialRosterInput" placeholder="Paste the initial roster text here..."></textarea>
            </div>
            <div class="input-group" id="finalRosterGroup">
                <label for="finalRosterInput" id="finalRosterLabel">Final Roster</label>
                <textarea id="finalRosterInput" placeholder="Paste the final published roster text here..."></textarea>
            </div>
        </div>
        
        <div class="help-section">
            <details>
                <summary>Help with Copy & Paste from PDF</summary>
                <div>
                    <p>If Ctrl+A doesn't select text across multiple pages in your PDF viewer, follow these steps:</p>
                    <ol>
                        <li>Find the original PDF file on your computer.</li>
                        <li><strong>Right-click</strong> on the file icon.</li>
                        <li>Go to <strong>"Open with"</strong> and select <strong>Google Chrome</strong> or <strong>Microsoft Edge</strong>.</li>
                        <li>Once the PDF opens in your browser, press <strong>Ctrl+A</strong> (or Cmd+A on Mac) to select all text.</li>
                        <li>Press <strong>Ctrl+C</strong> (or Cmd+C) to copy, then paste into the correct box above.</li>
                    </ol>
                </div>
            </details>
        </div>
        
        <div class="calculate-section">
            <button class="primary-button" onclick="runCalculation()">Calculate Pay</button>
        </div>
        
    </main>

    <div id="resultsModal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-button" onclick="hideResultsModal()">&times;</button>
            <div id="modal-results-content">
                </div>
        </div>
    </div>
    
    <script>
        // --- GLOBAL VARIABLES ---
        let calculationResults = {};

        // --- DATA CONSTANTS (EBA Rates updated with your provided CPI calculations) ---
        const EBA_DATA = {
            "Permanent": {
                "First Officer": { 1: 134645.51, 2: 140812.55, 3: 147931.28, 4: 153524.47, 5: 160049.07, 6: 167370.08 },
                "Captain": { 1: 213689.97, 2: 219975.39, 3: 227532.08, 4: 236339.95, 5: 246400.17, 6: 255208.04 }
            },
            "Casual": {
                "First Officer": { "Standard": 241.16, "GroundDuty": 470.00 },
                "Captain": { "Standard": 370.99, "GroundDuty": 620.00, "Training": 392.16, "Checking": 421.08 }
            },
            "ProductivityBonus": { "First Officer": 227.83, "Captain": 355.79 },
            "RDO_WorkRate": { "First Officer": 178.07, "Captain": 277.78 },
            "ExtendedDutyRate": { "First Officer": 178.07, "Captain": 277.78 },
            "MealAllowance": { "Breakfast": 34.88, "Lunch": 39.08, "Dinner": 67.19 },
            "AwayFromHomeAllowance": 166.43,
            "RHSAllowance": 1412.50, // Per quarter
            "TrainingCaptainAllowance": 12324.93, // Per annum
            "FlightExaminerCaptainAllowance": 24208.49, // Per annum
            "AssessmentAllowance": 376.92, // Daily allowance for FOs under assessment
            "SuperGuaranteeRate": 0.115 // As of July 2024
        };

        // --- UI FUNCTIONS ---
        function showResultsModal() { document.getElementById('resultsModal').style.display = 'flex'; }
        function hideResultsModal() { document.getElementById('resultsModal').style.display = 'none'; }
        function toggleDarkMode() {
            const body = document.body;
            const btn = document.getElementById('darkModeBtn');
            const isDark = body.classList.toggle('dark-mode');
            btn.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            localStorage.setItem('darkMode', isDark ? 'dark' : 'light');
        }
        function toggleMode() {
            const mode = document.getElementById('employmentType').value;
            const isCasual = mode === 'Casual';
            document.getElementById('permanentInputs').classList.toggle('hidden', isCasual);
            document.getElementById('casualInputs').classList.toggle('hidden', !isCasual);
            document.getElementById('initialRosterGroup').classList.toggle('hidden', isCasual);
            document.getElementById('rosterInputsContainer').classList.toggle('casual-mode', isCasual);
            document.getElementById('finalRosterLabel').textContent = isCasual ? 'Roster' : 'Final Roster';
        }

        // --- ON PAGE LOAD ---
        window.onload = function() {
            const savedMode = localStorage.getItem('darkMode');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedMode === 'dark' || (!savedMode && prefersDark)) {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeBtn').textContent = 'Light Mode';
            }
            // Sample data for easy testing - from the provided files
            document.getElementById('initialRosterInput').value = `TimeMode Local time
Roster
(01MAY25-31MAY25)
Kendell, Guy 0463AU BNE FO/73F
17APR25 00:36
Date Des. Code CI Dep STD Arr STA CO AC WA Func Rank BLH
12 Mon 0800 PAX BNE MEL 0900 1125 1155 FO
HTL MEL 1155 MEL 0250+ FO
13 Tue RCA 0250 QF7282 F MEL PER 0350 0605 0635 73P FO 04:15
Crew: CPFE(): Hanna, Christopher, FO(RCA): Kendell, Guy
HTL PER 0640 PER 1710 FO
RCA 1710 QF7281 F PER MEL 1810 2340 0010+ 73P FO 03:30
14 Wed HTL MEL MEL 0010 1325 FO
1325 PAX MEL BNE 1425 1640 1710 FO
15 Thu ADMIN BNE BNE 0900 1700 1700 FO
16 Fri ADMIN BNE BNE 0900 1700 1700 FO
17 Sat RDO BNE BNE 0000 2359 FO
18 Sun RDO BNE BNE 0000 2359 FO
19 Mon ADMIN BNE BNE 0900 1700 1700. FO
20 Tue 0800 PAX BNE MEL 0900 1125 1155 FO
HTL MEL MEL 1155 2340 FO
2340 QF7286 F MEL LST 0040 0140 73P FO 01:00
21 Wed F QF7287 LST MEL 0210 0310 0340 73P FO 01:00
HTL MEL 0340 MEL 0800+ FO
22 Thu 1 PREF MEL MEL 0800 1600 FO
PAX ACKD MEL 1830 BNE 2045 2115 FO
23 Fri ADMIN BNE BNE 0900 1700 1700 FO
24 Sat RDO BNE BNE 0000 2359 FO
25 Sun RDO BNE BNE 0000 2359 FO`;
            document.getElementById('finalRosterInput').value = `TimeMode Local time
Roster
(01MAY25-31MAY25)
Kendell, Guy 0463AU BNE FO/73F
25JUN25 00:53
Date Des. Code E Dep STD Arr CI STA CO AC WA Rank BLH Func
12 Mon PAX BNE 0800 MEL 1125 1155 FO
HTL MEL 1155 MEL 0250+ FO
13 Tue RCA QF7282 F 0250 MEL 0350 PER 0605 0635 73P FO 04:13
Crew: CPFE(): Hanna, Christopher, FO(RCA Y,X): Kendell, Guy
HTL PER 0640 PER 1710 FO
RCA QF7281 F 1710 PER 1810 MEL 2340 2344 73P FO 03:33
14 Wed HTL MEL 0010 MEL 2340 FO
LST 2340 MEL 0040 QF7286 F 0140 73P FO 01:12
15 Thu F QF7287 LST MEL 0210 0310 0335 73P 00:53 FO
HTL MEL 0310 MEL 0600 FO
PAX MEL 0600 BNE 0815 FO
17 Sat PAX 0905 BNE 1105 SIN 1725 1825 FO
HTL SIN 1825 SIN 0550+ FO
18 Sun XSP SIN 0550 CAR 0650 FO
AWK990 T 0700 XSP 0800 XSP 0930 73P 01:43 FO
AWK992 F XSP PER 1045 1610 1846 73P 06:02 FO
HTL PER 1846 PER 1000+ FO
20 Tue AWK992 F 1000 PER 1100 MEL 1630 1801 73P 03:46 FO
HTL MEL 1718 MEL 0800+ FO
22 Thu 1 PREF MEL 0800 MEL 1600 FO
PAX ACKD MEL 1830 BNE 2045 2115 FO
24 Sat RDO BNE 0000 BNE 2359 FO
25 Sun RDO BNE 0000 BNE 2359 FO`;
            
            document.getElementById('resultsModal').addEventListener('click', function(event) {
                if (event.target === this) { hideResultsModal(); }
            });
        };

        // --- CALCULATION & PARSING LOGIC ---
        function parseTimeToHours(timeStr) {
            if (!timeStr || typeof timeStr !== 'string') return 0;
            const cleanedTime = timeStr.replace(/[^0-9]/g, '');
            if (cleanedTime.length < 3) return 0;
            const hours = parseInt(cleanedTime.slice(0, -2), 10);
            const minutes = parseInt(cleanedTime.slice(-2), 10);
            if (isNaN(hours) || isNaN(minutes)) return 0;
            return hours + (minutes / 60);
        }
        
        function parseRoster(rosterText) {
            const dutyMap = new Map();
            const lines = rosterText.trim().split('\n');
            let rosterPeriod = null;
            const dateRangeRegex = /\((\d{2}[A-Z]{3}\d{2})\s*-\s*(\d{2}[A-Z]{3}\d{2})\)/;
            const rangeMatch = rosterText.match(dateRangeRegex);
            if (rangeMatch) rosterPeriod = { start: rangeMatch[1], end: rangeMatch[2] };
            
            let currentDayEntries = [];
            for (const line of lines) {
                if (/^\d{2}\s+(Sun|Mon|Tue|Wed|Thu|Fri|Sat)/.test(line.trim())) {
                    if (currentDayEntries.length > 0) {
                        const date = currentDayEntries[0].trim().split(/\s+/)[0];
                        dutyMap.set(date, processDayEntries(currentDayEntries));
                    }
                    currentDayEntries = [line];
                } else if (currentDayEntries.length > 0) { 
                    currentDayEntries.push(line); 
                }
            }
            if (currentDayEntries.length > 0) {
                const date = currentDayEntries[0].trim().split(/\s+/)[0];
                dutyMap.set(date, processDayEntries(currentDayEntries));
            }
            return { dutyMap, rosterPeriod };
        }

        function processDayEntries(entries) {
            const firstLineParts = entries[0].trim().split(/\s+/);
            const dayInfo = { 
                date: firstLineParts[0], 
                dutyCode: firstLineParts[2] || 'UNKNOWN', 
                std: '0000', 
                signOff: '0000', 
                blockHours: 0, 
                isLayover: false, 
                isGroundDuty: false 
            };
            let dutyStartTime = null, dutyEndTime = null;
            const groundDutyCodes = ['ADMIN', 'SIM', 'FETC', 'PREF'];
            
            entries.forEach(line => {
                if (groundDutyCodes.some(code => line.includes(code))) {
                    dayInfo.isGroundDuty = true;
                }
                const blockHoursMatch = line.match(/(\d{1,2}:\d{2})$/);
                if (blockHoursMatch) {
                    dayInfo.blockHours += parseTimeToHours(blockHoursMatch[0]);
                }
                if (line.includes('HTL')) {
                    dayInfo.isLayover = true;
                }

                const timeMatches = line.match(/\b\d{4}\b/g) || [];
                if (timeMatches.length > 0) {
                     dutyStartTime = dutyStartTime || timeMatches[0];
                     dutyEndTime = timeMatches[timeMatches.length - 1];
                }
            });

            dayInfo.std = dutyStartTime || '0000';
            dayInfo.signOff = dutyEndTime || '0000';
            return dayInfo;
        }

        function compareRosters(initialRoster, finalRoster) {
            const changes = [];
            const buffer = 2.0;
            finalRoster.forEach((finalDuty, date) => {
                const initialDuty = initialRoster.get(date);
                if (!initialDuty) {
                    changes.push({ date, type: "NEW_DUTY", description: `New duty '${finalDuty.dutyCode}' added.` });
                    return;
                }

                if (initialDuty.dutyCode === 'RDO' && finalDuty.dutyCode !== 'RDO') {
                    const subType = finalDuty.blockHours > 0 ? 'flying' : 'non-flying';
                    const hours = subType === 'flying' ? Math.max(3, finalDuty.blockHours) : 8;
                    changes.push({ date, type: "RDO_WORKED", subType: subType, description: `RDO changed to ${finalDuty.dutyCode}.`, hours: hours });
                } else if (initialDuty.dutyCode !== 'RDO' && (initialDuty.dutyCode !== finalDuty.dutyCode || initialDuty.std !== finalDuty.std)) {
                     const initialTime = parseTimeToHours(initialDuty.std);
                     const finalTime = parseTimeToHours(finalDuty.std);
                     const timeDiff = Math.abs(initialTime - finalTime);
                     if (timeDiff > buffer) {
                        const hourDifference = Math.max(0, finalDuty.blockHours - initialDuty.blockHours);
                        changes.push({ date, type: "OUTSIDE_BUFFER", description: `Duty changed outside buffer (Net change: ${hourDifference.toFixed(2)} hrs)`, hours: hourDifference });
                     }
                }
            });
            return changes;
        }
        
        function calculatePermanentPay(finalRosterData, level, rank, detectedChanges) {
            const annualSalary = EBA_DATA.Permanent[rank]?.[level];
            if (!annualSalary) return { totalGrossPay: 0 };

            let rosterChangeAllowance = 0;
            const rdoRate = EBA_DATA.RDO_WorkRate[rank] || 0;
            const extendedRate = EBA_DATA.ExtendedDutyRate[rank] || 0;
            
            detectedChanges.forEach(change => {
                if (change.type === 'RDO_WORKED') {
                    if (change.subType === 'flying') {
                        rosterChangeAllowance += change.hours * rdoRate;
                    } else { // non-flying/positioning
                        rosterChangeAllowance += (annualSalary / 260); // One day's pay
                    }
                } else if (change.type === 'OUTSIDE_BUFFER') {
                    rosterChangeAllowance += change.hours * extendedRate;
                }
            });

            const { totalAllowance: mealAndLayoverAllowance } = calculateAllowances(finalRosterData);

            let otherAllowances = 0;
            const payPeriodDays = parseInt(document.getElementById('payPeriod').value, 10);
            const periodsPerYear = 365.25 / payPeriodDays;

            if (document.getElementById('isRHS').checked) {
                otherAllowances += EBA_DATA.RHSAllowance / (periodsPerYear / 4); 
            }
            if (document.getElementById('isTrainingCaptain').checked) {
                otherAllowances += EBA_DATA.TrainingCaptainAllowance / periodsPerYear;
            }
            if (document.getElementById('isFlightExaminer').checked) {
                otherAllowances += EBA_DATA.FlightExaminerCaptainAllowance / periodsPerYear;
            }

            const assessmentDays = parseInt(document.getElementById('assessmentDays').value, 10);
            if (assessmentDays > 0) {
                 otherAllowances += assessmentDays * EBA_DATA.AssessmentAllowance;
            }
            
            let totalBlockHours = 0;
            finalRosterData.dutyMap.forEach(duty => totalBlockHours += duty.blockHours);
            let productivityBonus = 0;
            // Productivity bonus is monthly, so only calculate if pay period is monthly
            if (payPeriodDays > 27 && totalBlockHours > 60) {
                const bonusHours = totalBlockHours - 60;
                productivityBonus = bonusHours * EBA_DATA.ProductivityBonus[rank];
            }

            const basePay = annualSalary / periodsPerYear;
            const superablePay = basePay + rosterChangeAllowance + otherAllowances + productivityBonus;
            const superContribution = superablePay * EBA_DATA.SuperGuaranteeRate;
            const totalGrossPay = basePay + rosterChangeAllowance + mealAndLayoverAllowance + otherAllowances + productivityBonus;
            
            return { basePay, rosterChangeAllowance, mealAndLayoverAllowance, otherAllowances, productivityBonus, superContribution, totalGrossPay, totalBlockHours };
        }

        function calculateCasualPay(finalRosterData, rank) {
            const casualRates = EBA_DATA.Casual[rank];
            let flightPay = 0, groundPay = 0, totalBlockHours = 0, groundDutyDays = 0;
            finalRosterData.dutyMap.forEach(duty => {
                if(duty.isGroundDuty) {
                    groundDutyDays++;
                    groundPay += casualRates.GroundDuty;
                } else if(duty.blockHours > 0) {
                     const paidHours = Math.max(3, duty.blockHours); // Min 3 hour payment per duty
                     flightPay += paidHours * casualRates.Standard;
                     totalBlockHours += duty.blockHours;
                }
            });
            const totalGrossPay = flightPay + groundPay;
            const superContribution = totalGrossPay * EBA_DATA.SuperGuaranteeRate;
            return { totalBlockHours, groundDutyDays, totalGrossPay, groundPay, flightPay, superContribution };
        }

        function calculateAllowances(finalRosterData) {
            let totalAllowance = 0;
            finalRosterData.dutyMap.forEach(duty => {
                if (duty.isLayover) {
                    totalAllowance += EBA_DATA.AwayFromHomeAllowance;
                } else {
                    const dutyStart = parseTimeToHours(duty.std);
                    const dutyEnd = parseTimeToHours(duty.signOff);
                    let dutyDuration = dutyEnd >= dutyStart ? dutyEnd - dutyStart : (24 - dutyStart) + dutyEnd;
                    
                    if(dutyDuration > 11) {
                        // Per EBA, entitled to the 'relevant meal allowance'. A long day might span multiple.
                        // For simplicity and matching the payslip, we'll add one dinner allowance.
                        totalAllowance += EBA_DATA.MealAllowance.Dinner; 
                    }
                }
            });
            return { totalAllowance };
        }

        function updateModalContent() {
            const res = calculationResults;
            const contentDiv = document.getElementById('modal-results-content');
            const formatCurrency = (value) => value.toLocaleString('en-AU', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            const payPeriodDays = parseInt(document.getElementById('payPeriod').value, 10);
            const periodName = payPeriodDays === 14 ? 'Fortnightly' : 'Monthly';

            if (res.error) {
                 contentDiv.innerHTML = `<h3>Error</h3><p>${res.error}</p>`;
                 return;
            }
            
            if (res.mode === 'Permanent') {
                let changesHtml = '<h4>Detected Roster Changes</h4>';
                if (res.detectedChanges.length > 0) {
                    changesHtml += '<ul class="changes-list">';
                    res.detectedChanges.forEach(change => {
                        changesHtml += `<li><strong>${change.date}:</strong> ${change.description}</li>`;
                    });
                    changesHtml += '</ul>';
                } else {
                    changesHtml += '<p>No pay-relevant changes detected between rosters.</p>';
                }
                contentDiv.innerHTML = `
                    <h3>Pay Calculation Results (Permanent ${periodName})</h3>
                    <div class="results-grid">
                        <p class="label">Rank:</p><p>${res.finalRank}</p>
                        <p class="label">Annual Salary:</p><p>$${formatCurrency(EBA_DATA.Permanent[res.finalRank][res.level])}</p>
                    </div><hr>${changesHtml}<hr>
                    <h4>Pay Component Breakdown</h4>
                    <div class="results-grid">
                        <p class="label">Base Pay:</p><p>$${formatCurrency(res.basePay)}</p>
                        <p class="label">Roster Change Allowances:</p><p>$${formatCurrency(res.rosterChangeAllowance)}</p>
                        <p class="label">Productivity Bonus:</p><p>$${formatCurrency(res.productivityBonus)}</p>
                        <p class="label">Meal & Layover Allowances:</p><p>$${formatCurrency(res.mealAndLayoverAllowance)}</p>
                        <p class="label">Other Duty Allowances:</p><p>$${formatCurrency(res.otherAllowances)}</p>
                    </div>
                    <div class="total-pay-section">
                        <h4>Estimated Total ${periodName} Gross Pay:</h4>
                        <p>$${formatCurrency(res.totalGrossPay)}</p>
                    </div>
                    <hr>
                    <div class="results-grid">
                         <p class="label">Superannuation Contribution:</p><p>$${formatCurrency(res.superContribution)}</p>
                    </div>`;
            } else if (res.mode === 'Casual') {
                 contentDiv.innerHTML = `
                    <h3>Pay Calculation Results (Casual)</h3>
                     <div class="results-grid">
                        <p class="label">Rank:</p><p>${res.finalRank}</p>
                    </div><hr>
                    <h4>Pay Component Breakdown</h4>
                    <div class="results-grid">
                        <p class="label">Flight Pay (${res.totalBlockHours.toFixed(2)} hrs):</p><p>$${formatCurrency(res.flightPay)}</p>
                        <p class="label">Ground Duty Pay (${res.groundDutyDays} days):</p><p>$${formatCurrency(res.groundPay)}</p>
                    </div>
                    <div class="total-pay-section">
                        <h4>Estimated Total Gross Pay:</h4>
                        <p>$${formatCurrency(res.totalGrossPay)}</p>
                    </div>
                    <hr>
                    <div class="results-grid">
                         <p class="label">Superannuation Contribution:</p><p>$${formatCurrency(res.superContribution)}</p>
                    </div>`;
            }
        }

        function runCalculation() {
            try {
                const employmentType = document.getElementById('employmentType').value;
                
                if(employmentType === 'Permanent') {
                    let initialRosterText = document.getElementById('initialRosterInput').value;
                    let finalRosterText = document.getElementById('finalRosterInput').value;

                    if (!initialRosterText.trim() || !finalRosterText.trim()) {
                        throw new Error("Initial and Final Roster inputs cannot be empty for Permanent pilots.");
                    }

                    const rank = document.getElementById('rankSelect').value;
                    const level = document.getElementById('levelSelect').value;
                    const initialRosterData = parseRoster(initialRosterText);
                    const finalRosterData = parseRoster(finalRosterText);
                    const detectedChanges = compareRosters(initialRosterData.dutyMap, finalRosterData.dutyMap);
                    const permanentPay = calculatePermanentPay(finalRosterData, level, rank, detectedChanges);

                    calculationResults = {
                        mode: 'Permanent',
                        finalRank: rank,
                        level: level,
                        ...permanentPay,
                        detectedChanges
                    };

                } else { // Casual
                    const finalRosterText = document.getElementById('finalRosterInput').value;
                    if (!finalRosterText.trim()) {
                        throw new Error("Roster input cannot be empty for Casual pilots.");
                    }
                    const finalRosterData = parseRoster(finalRosterText);
                    const rank = document.getElementById('casualRankSelect').value;
                    const casualPay = calculateCasualPay(finalRosterData, rank);

                    calculationResults = {
                        mode: 'Casual',
                        finalRank: rank,
                        ...casualPay,
                    };
                }
            } catch (e) {
                console.error("Calculation Error:", e);
                calculationResults = { error: e.message };
            }
            
            updateModalContent();
            showResultsModal();
        }

    </script>
</body>
</html>
